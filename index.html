<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>RAK.TF</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Space+Mono:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --red: #C41E3A;
      --black: #0B0B0B;
      --dark: #121212;
      --darker: #0A0A0A;
      --glow: 0 0 25px rgba(196,30,58,0.6);
      --transition: 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      --fast: 0.3s ease-out;
      --border: 1px solid rgba(196,30,58,0.3);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body, html { height:100%; overflow:hidden; font-family:'Space Mono',monospace; background:var(--black); color:#fff; will-change:transform; }
    #loader {
      position:fixed; top:0; left:0; width:100%; height:100%; background:var(--black); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
    #loader h1 { font-family:'Orbitron',sans-serif; font-size:3.8rem; color:var(--red); text-shadow:0 0 20px var(--red); letter-spacing:8px; animation: glitch 2s infinite; }
    @keyframes glitch { 0%,100%{text-shadow:0 0 20px var(--red)} 50%{text-shadow:2px 0 0 #0f0,-2px 0 0 #00f} }
    #loader p { color:#666; margin-top:16px; font-size:1rem; letter-spacing:3px; }
    #loader .bar { width:320px; height:5px; background:#222; margin-top:24px; border-radius:2px; overflow:hidden; }
    #loader .fill { width:0%; height:100%; background:var(--red); animation: load 2.8s ease-in-out forwards; }
    @keyframes load { to { width:100%; } }

    #app { position:relative; width:100%; height:100%; perspective:1500px; overflow:hidden; display:none; transform-style:preserve-3d; }
    .page { position:absolute; top:80px; left:0; width:100%; height:calc(100% - 80px); opacity:0; visibility:hidden; transform-style:preserve-3d; transition:opacity var(--transition), transform var(--transition); backface-visibility:hidden; display:flex; flex-direction:column; align-items:center; padding:20px; }
    .page.active { opacity:1; visibility:visible; transform:rotateY(0) scale(1); z-index:10; }
    .page.prev { transform:rotateY(-60deg) translateX(-100%) scale(0.9); }
    .page.next { transform:rotateY(60deg) translateX(100%) scale(0.9); }

    .top-bar { position:fixed; top:0; left:0; width:100%; height:80px; background:rgba(18,18,18,0.95); backdrop-filter:blur(12px); padding:16px 20px; display:none; align-items:center; justify-content:space-between; z-index:200; border-bottom:var(--border); }
    .top-bar.active { display:flex; }
    .logo { font-family:'Orbitron',sans-serif; color:var(--red); font-size:1.8rem; letter-spacing:4px; cursor:pointer; }
    .user-info { display:flex; align-items:center; gap:12px; }
    .user-name { color:var(--red); font-weight:700; font-size:1.1rem; }
    .balance { color:#0f0; font-weight:700; font-size:1.1rem; }
    .nav-btn { background:var(--darker); border:var(--border); padding:10px 16px; border-radius:12px; color:#aaa; font-size:0.9rem; cursor:pointer; transition:var(--fast); will-change:transform; }
    .nav-btn:hover { background:var(--red); color:#fff; transform:scale(1.05); }

    .container { background:var(--dark); border-radius:18px; padding:32px; max-width:560px; width:100%; box-shadow:var(--glow), 0 40px 80px rgba(0,0,0,0.9); backdrop-filter:blur(18px); border:var(--border); position:relative; transform-style:preserve-3d; }
    .container::before { content:''; position:absolute; inset:0; border-radius:18px; padding:3px; background:linear-gradient(45deg, transparent, var(--red), transparent); -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none; opacity:0.7; }

    .input-group { margin:20px 0; }
    .input-group input { width:100%; padding:18px; background:var(--darker); border:var(--border); border-radius:14px; color:#fff; font-size:1.1rem; transition:0.3s; font-family:'Roboto Mono',monospace; }
    .input-group input:focus { outline:none; border-color:var(--red); box-shadow:0 0 18px rgba(196,30,58,0.6); }

    .btn { background:var(--red); color:#fff; border:none; padding:16px 32px; border-radius:14px; font-weight:700; cursor:pointer; transition:var(--fast); position:relative; overflow:hidden; width:100%; margin-top:20px; font-size:1.2rem; will-change:transform; }
    .btn::before { content:''; position:absolute; top:50%; left:50%; width:0; height:0; background:rgba(255,255,255,0.3); border-radius:50%; transform:translate(-50%,-50%); transition:0.6s; }
    .btn:hover::before { width:300px; height:300px; }
    .btn:hover { background:#e63946; transform:translateY(-4px) scale(1.02); box-shadow:var(--glow); }

    .card-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:20px; margin:28px 0; max-height:calc(100vh - 300px); overflow-y:auto; padding:14px; scrollbar-width:thin; scrollbar-color:var(--red) transparent; }
    .card-item { background:var(--darker); border-radius:16px; padding:20px; text-align:center; cursor:pointer; transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1); border:var(--border); position:relative; overflow:hidden; transform-style:preserve-3d; will-change:transform; }
    .card-item::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background:radial-gradient(circle at 50% 50%, rgba(196,30,58,0.3), transparent); opacity:0; transition:0.5s; }
    .card-item:hover::before { opacity:1; }
    .card-item:hover { transform:translateY(-12px) rotateX(15deg) rotateY(10deg) scale(1.05); box-shadow:var(--glow), 0 30px 60px rgba(196,30,58,0.4); }
    .card-item .bin { font-weight:700; font-size:1.2rem; color:#fff; margin-bottom:8px; }
    .card-item .type { font-size:0.9rem; color:#aaa; margin-bottom:6px; }
    .card-item .price { color:var(--red); font-weight:700; font-size:1.4rem; text-shadow:0 0 14px var(--red); }

    .fly-clone { position:fixed; z-index:9999; pointer-events:none; transform-style:preserve-3d; }
    .fly-clone.active { animation: flyToCart 1s cubic-bezier(0.2,0.8,0.4,1) forwards; }
    @keyframes flyToCart {
      0% { transform:scale(1) rotateX(0) rotateY(0); opacity:1; }
      70% { transform:scale(0.6) rotateX(30deg) rotateY(-20deg); opacity:0.8; }
      100% { transform:scale(0.3) translateX(var(--tx)) translateY(var(--ty)) rotateX(45deg); opacity:0; }
    }

    .qty-controls { display:flex; justify-content:center; align-items:center; gap:10px; margin:16px 0; }
    .qty-btn { background:var(--darker); border:var(--border); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:var(--fast); font-size:1.4rem; }
    .qty-btn:hover { background:var(--red); transform:scale(1.1); }
    .qty-num { font-weight:700; min-width:40px; text-align:center; font-size:1.2rem; }

    .cart-icon { position:fixed; bottom:24px; left:24px; background:var(--red); width:70px; height:70px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:99; box-shadow:var(--glow); transition:transform 0.3s ease; }
    .cart-icon.shake { animation: shake 0.5s ease; }
    @keyframes shake { 0%,100%{transform:rotate(0)} 25%{transform:rotate(-15deg)} 75%{transform:rotate(15deg)} }

    .support-btn { position:fixed; bottom:24px; right:24px; background:var(--red); width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:var(--glow); cursor:pointer; z-index:99; font-size:2rem; color:#fff; }

    .cat-tabs { display:flex; gap:12px; margin:20px 0; justify-content:center; flex-wrap:wrap; }
    .cat-tab { background:var(--darker); color:#aaa; border:var(--border); padding:12px 20px; border-radius:12px; font-size:1rem; cursor:pointer; transition:var(--fast); font-weight:700; }
    .cat-tab.active { background:var(--red); color:#fff; border-color:var(--red); box-shadow:var(--glow); }
    .cat-tab:hover { border-color:var(--red); }

    .search-bar { width:100%; padding:18px; background:var(--darker); border:var(--border); border-radius:14px; color:#fff; margin-bottom:20px; font-size:1.1rem; transition:0.4s; font-family:'Roboto Mono',monospace; }
    .search-bar:focus { outline:none; box-shadow:0 0 20px var(--red); }

    .invoice-popup {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0.9); background:var(--dark); border-radius:18px; padding:32px; max-width:400px; width:90%; box-shadow:var(--glow), 0 40px 80px rgba(0,0,0,0.9); z-index:9999; opacity:0; visibility:hidden; transition:0.4s;
    }
    .invoice-popup.show { opacity:1; visibility:visible; transform:translate(-50%,-50%) scale(1); }
    .invoice-close { position:absolute; top:12px; right:16px; background:none; border:none; color:#aaa; font-size:1.6rem; cursor:pointer; }
    .invoice-qr { width:180px; height:180px; margin:20px auto; }
    .invoice-addr { background:#1a1a1a; padding:12px; border-radius:8px; word-break:break-all; font-family:'Roboto Mono'; font-size:0.9rem; }
    .copy-btn { background:var(--red); color:#fff; border:none; padding:8px 16px; border-radius:10px; font-size:0.9rem; cursor:pointer; margin-top:10px; }

    .credit-options { display:flex; gap:12px; margin:20px 0; flex-wrap:wrap; justify-content:center; }
    .credit-btn { background:var(--darker); border:var(--border); padding:14px 24px; border-radius:12px; font-weight:700; cursor:pointer; transition:var(--fast); }
    .credit-btn.active { background:var(--red); color:#fff; }

    .payment-status { text-align:center; margin:20px 0; font-size:1.1rem; }
    .status-pending { color:#ff0; }
    .status-paid { color:#0f0; }
    .conf-count { font-weight:700; }

    .low-stock { color:#ff0; text-align:center; animation:pulse 2s infinite; font-weight:700; margin:20px 0; }

    .chat-bubble { background:#1a1a1a; padding:12px; border-radius:12px; margin:8px 0; max-width:80%; white-space:pre-wrap; }
    .chat-you { align-self:flex-end; background:var(--red); color:#fff; }
    .chat-bot { align-self:flex-start; }

    @media (max-width:768px) {
      .top-bar { height:70px; padding:12px 16px; }
      .page { top:70px; height:calc(100% - 70px); }
      .card-grid { max-height:calc(100vh - 320px); }
    }
  </style>
</head>
<body>

  <div id="loader">
    <div>
      <h1>RAK.TF</h1>
      <p>VAULT ACCESS</p>
      <div class="bar"><div class="fill"></div></div>
    </div>
  </div>

  <div id="copy-feedback" style="position:fixed; bottom:100px; right:24px; background:#0f0; color:#000; padding:12px 18px; border-radius:14px; font-weight:700; opacity:0; transition:0.4s; z-index:999;">COPIED</div>

  <!-- INVOICE POPUP -->
  <div id="invoice-popup" class="invoice-popup">
    <button class="invoice-close">×</button>
    <h2 style="text-align:center; color:var(--red);">BTC INVOICE</h2>
    <p style="text-align:center; margin:16px 0;" id="invoice-amount">$0.00</p>
    <canvas id="invoice-qr" class="invoice-qr"></canvas>
    <p class="invoice-addr" id="invoice-addr"></p>
    <button class="copy-btn" id="copy-addr">COPY ADDRESS</button>
    <p style="text-align:center; color:#aaa; margin-top:12px; font-size:0.8rem;" id="invoice-timer">LOCKED FOR 15:00</p>
  </div>

  <div id="app">
    <div class="top-bar" id="top-bar">
      <div class="logo" id="home-btn">RAK.TF</div>
      <div class="user-info">
        <span class="user-name" id="user-name">USER</span>
        <span class="balance" id="balance">$0.00</span>
      </div>
      <div style="display:flex; gap:12px;">
        <button class="nav-btn" id="add-credits-top">ADD CREDITS</button>
        <button class="nav-btn" id="history-top">HISTORY</button>
      </div>
    </div>

    <div class="support-btn" id="support-btn">?</div>

    <div class="cart-icon" id="cart-icon">
      <svg viewBox="0 0 24 24" style="width:38px; height:38px; fill:#fff;"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
      <div class="cart-count" id="cart-count" style="display:none; position:absolute; top:-8px; right:-8px; background:#000; color:var(--red); width:28px; height:28px; border-radius:50%; font-size:0.8rem; display:flex; align-items:center; justify-content:center; font-weight:700;">0</div>
    </div>

    <!-- LOGIN -->
    <section id="login" class="page active">
      <div class="container" style="max-width:420px;">
        <h1 style="font-family:'Orbitron',sans-serif; text-align:center; color:var(--red); font-size:3.2rem; letter-spacing:8px; text-shadow:0 0 18px var(--red);">RAK.TF</h1>
        <p style="text-align:center; color:#666; margin-bottom:28px;">ENTER CREDENTIALS</p>
        <div class="input-group"><input type="text" id="username" placeholder="USERNAME" autocomplete="off" /></div>
        <div class="input-group"><input type="password" id="password" placeholder="PASSWORD" autocomplete="off" /></div>
        <button class="btn" id="login-btn">ENTER VAULT</button>
        <p style="text-align:center; color:#0f0; margin-top:16px; font-size:0.8rem;">ANY USERNAME + PASSWORD WORKS</p>
      </div>
    </section>

    <!-- SHOP -->
    <section id="shop" class="page">
      <div class="container" style="max-width:1000px;">
        <h2>VAULT INVENTORY</h2>
        <p class="low-stock">⚠️ LOW ON STOCK — ONLY 15 CCs LEFT ⚠️</p>
        <div class="cat-tabs">
          <button class="cat-tab active" data-cat="all">ALL</button>
          <button class="cat-tab" data-cat="cc">CCs</button>
        </div>
        <input type="text" id="search-bar" class="search-bar" placeholder="SEARCH BIN / NAME..." />
        <div id="card-grid" class="card-grid"></div>
      </div>
    </section>

    <!-- DETAIL -->
    <section id="detail" class="page">
      <div class="container">
        <div id="detail-content" style="text-align:center;"></div>
        <div class="qty-controls">
          <div class="qty-btn" id="qty-minus">-</div>
          <div class="qty-num" id="qty-num">1</div>
          <div class="qty-btn" id="plus">+</div>
        </div>
        <div class="max-warning" id="max-warning">MAX 3 PER ORDER</div>
        <button class="btn" id="add-to-cart">ADD TO CART</button>
      </div>
    </section>

    <!-- CART -->
    <section id="cart" class="page">
      <div class="container">
        <h2>CART</h2>
        <div id="cart-items"></div>
        <div style="margin:20px 0; text-align:center; font-size:1.4rem; color:var(--red);" id="cart-total">$0.00</div>
        <button class="btn" id="checkout-btn">CHECKOUT</button>
        <button class="btn" style="background:#333; margin-top:10px;" id="clear-cart">CLEAR CART</button>
      </div>
    </section>

    <!-- CHECKOUT -->
    <section id="checkout" class="page">
      <div class="container">
        <h2>CHECKOUT</h2>
        <div id="checkout-summary"></div>
        <div class="input-group"><input type="email" id="email" placeholder="EMAIL FOR DELIVERY" /></div>
        <button class="btn" id="pay-btn">PAY WITH BTC</button>
      </div>
    </section>

    <!-- PAYMENT -->
    <section id="payment" class="page">
      <div class="container">
        <h2>PAYMENT</h2>
        <div id="payment-summary"></div>
        <canvas id="qr-code" style="margin:20px auto; width:200px; height:200px; display:block;"></canvas>
        <p style="text-align:center; word-break:break-all; background:#1a1a1a; padding:12px; border-radius:8px; font-family:'Roboto Mono';">1NtpN3aPZowqEzX16E5cMUHQ16P9KHQtiy</p>
        <p class="btc-price" style="text-align:center; color:#0f0; margin:12px 0;"></p>
        <div class="payment-status status-pending" id="payment-status">
          Scanning blockchain... <span class="conf-count">0/1</span> confirmations
        </div>
        <button class="btn" id="payment-done" style="margin-top:20px; display:none;">PAYMENT RECEIVED</button>
      </div>
    </section>

    <!-- ORDER -->
    <section id="order" class="page">
      <div class="container">
        <h2>ORDER COMPLETE</h2>
        <p style="text-align:center; color:#0f0; font-size:1.2rem;" id="order-id"></p>
        <div id="order-items"></div>
        <button class="btn" id="copy-all">COPY ALL</button>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="history" class="page">
      <div class="container">
        <h2>HISTORY</h2>
        <h3 style="color:#0f0; margin:20px 0 10px;">PAID ORDERS</h3>
        <div id="paid-orders"></div>
        <h3 style="color:#ff0; margin:30px 0 10px;">PENDING PAYMENT</h3>
        <div id="pending-orders"></div>
      </div>
    </section>

    <!-- ADD CREDITS -->
    <section id="add-credits" class="page">
      <div class="container">
        <h2>ADD CREDITS</h2>
        <div class="credit-options">
          <button class="credit-btn active" data-amt="10">$10</button>
          <button class="credit-btn" data-amt="50">$50</button>
          <button class="credit-btn" data-amt="100">$100</button>
          <input type="number" placeholder="CUSTOM" id="custom-amt" style="background:var(--darker); border:var(--border); padding:14px; border-radius:12px; color:#fff; font-family:'Roboto Mono'; width:100%; margin-top:12px;" />
        </div>
        <button class="btn" id="add-credits-pay">GENERATE INVOICE</button>
      </div>
    </section>

    <!-- SUPPORT -->
    <section id="support" class="page">
      <div class="container">
        <h2 style="color:var(--red);">SUPPORT</h2>
        <p class="low-stock">LOW ON STOCK — ACT FAST</p>
        <div id="support-chat" style="background:#1a1a1a; padding:20px; border-radius:12px; height:60vh; overflow-y:auto; font-family:'Roboto Mono'; display:flex; flex-direction:column; gap:8px;"></div>
        <div class="input-group" style="margin-top:20px;">
          <input type="text" id="support-input" placeholder="TYPE ORDER ID (RAK-XXXXXX) OR ISSUE..." />
        </div>
        <button class="btn" id="send-support">SEND</button>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
  <script>
    const state = { 
      page: 'login', cart: [], cards: [], selected: null, orderId: '', email: '',
      loggedIn: false, username: '', balance: 0, history: JSON.parse(localStorage.getItem('rak_history') || '[]'),
      btcPrice: 60000, priceLockTime: 900,
      pendingPayment: null, pollInterval: null,
      supportStep: '', currentOrder: ''
    };
    const BTC_ADDR = '1NtpN3aPZowqEzX16E5cMUHQ16P9KHQtiy';
    const BLOCKCYPHER_TOKEN = '0d7ed1d3d24e4ffeaf43fa555cdd0c49';

    // LIVE BTC
    async function updateBtcPrice() {
      try {
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const d = await r.json();
        state.btcPrice = d.bitcoin.usd;
        document.querySelectorAll('.btc-price').forEach(el => {
          const usd = parseFloat(el.dataset.usd || 0);
          if (usd > 0) {
            const btc = (usd / state.btcPrice).toFixed(8);
            el.textContent = `${btc} BTC (~$${usd.toFixed(2)}) @ $${state.btcPrice.toLocaleString()}/BTC`;
          }
        });
      } catch(e) {}
    }
    updateBtcPrice(); setInterval(updateBtcPrice, 30000);

    // UNIQUE ID — FIXED
    function genId() {
      const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let id = 'RAK-';
      for (let i = 0; i < 8; i++) {
        id += c.charAt(Math.floor(Math.random() * c.length));
      }
      return id;
    }

    // FLY TO CART
    function flyCard(card, target) {
      const clone = card.cloneNode(true);
      clone.classList.add('fly-clone');
      const rect = card.getBoundingClientRect();
      const targetRect = target.getBoundingClientRect();
      clone.style.left = rect.left + 'px';
      clone.style.top = rect.top + 'px';
      clone.style.width = rect.width + 'px';
      clone.style.height = rect.height + 'px';
      document.body.appendChild(clone);
      requestAnimationFrame(() => {
        clone.classList.add('active');
        clone.style.setProperty('--tx', (targetRect.left + 35 - rect.left - rect.width/2) + 'px');
        clone.style.setProperty('--ty', (targetRect.top + 35 - rect.top - rect.height/2) + 'px');
      });
      setTimeout(() => clone.remove(), 1000);
      target.classList.add('shake');
      setTimeout(() => target.classList.remove('shake'), 500);
    }

    // PAGE TRANSITION
    function goTo(id) {
      if (!state.loggedIn && id !== 'login') return;
      const current = document.querySelector('.page.active');
      const next = document.getElementById(id);
      if (current && current !== next) {
        current.classList.remove('active');
        current.classList.add(id === 'login' ? 'next' : 'prev');
      }
      requestAnimationFrame(() => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active', 'prev', 'next'));
        next.classList.add('active');
      });
      state.page = id;
      if (id === 'shop') renderShop();
      if (id === 'detail') renderDetail();
      if (id === 'cart') renderCart();
      if (id === 'checkout') renderCheckout();
      if (id === 'payment') renderPayment();
      if (id === 'order') renderOrder();
      if (id === 'history') renderHistory();
      if (id === 'add-credits') renderAddCredits();
      if (id === 'support') renderSupport();
    }

    // LOGIN
    document.getElementById('login-btn').addEventListener('click', () => {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      if (u && p) {
        state.loggedIn = true;
        state.username = u.toUpperCase();
        document.getElementById('user-name').textContent = state.username;
        document.getElementById('top-bar').classList.add('active');
        localStorage.setItem('rak_auth', 'true');
        localStorage.setItem('rak_user', u);
        goTo('shop');
      } else {
        alert('ENTER BOTH FIELDS');
      }
    });

    // AUTO-LOGIN
    if (localStorage.getItem('rak_auth') === 'true') {
      const u = localStorage.getItem('rak_user');
      if (u) {
        state.loggedIn = true;
        state.username = u.toUpperCase();
        document.getElementById('user-name').textContent = state.username;
        document.getElementById('top-bar').classList.add('active');
        goTo('shop');
      }
    }

    // HOME BUTTON
    document.getElementById('home-btn').onclick = () => goTo('shop');

    // REAL STOCK — 15 CCs @ $7.50
    const realStock = [
      { id: 'cc1', bin: '6011008657955826', exp: '08/26', cvv: '665', name: 'Aubyn Barstrom-Veno', addr: '177 West Tisbury Rd, Edgartown, MA 02539', phone: '17745630811', email: 'abarstrom@gmail.com', price: 7.50 },
      { id: 'cc2', bin: '4447962648411837', exp: '07/28', cvv: '650', name: 'Charles Cole', addr: '2578 Haul Rd, West Oneonta, NY 13861', phone: '+19202729589', email: 'charles_cole_5978@outlook.com', price: 7.50 },
      { id: 'cc3', bin: '4100390203457722', exp: '03/31', cvv: '653', name: 'Leah Davis', addr: '11201 Aster St, Ventura, CA 93004', phone: '8052367069', email: 'leahdavis@verizon.net', price: 7.50 },
      { id: 'cc4', bin: '6011002373898352', exp: '10/26', cvv: '224', name: 'Stephanie Hiller', addr: '2914 67TH AVE #100, Greeley, CO 80634', phone: '3188842817', email: 'meaf22@gmail.com', price: 7.50 },
      { id: 'cc5', bin: '4347697113488453', exp: '04/29', cvv: '388', name: 'Adrienne Smith', addr: '2755 Shingleton Rd, Grand Rapids, MI 49503', phone: '+12035512912', email: 'adriennesmith@gmail.com', price: 7.50 },
      { id: 'cc6', bin: '5178059946795458', exp: '02/29', cvv: '146', name: 'Natasha Little', addr: '948 Peck Ct, Los Angeles, CA 90017', phone: '+15092522564', email: 'natashalittle8@gmail.com', price: 7.50 },
      { id: 'cc7', bin: '4912055084933780', exp: '05/29', cvv: '993', name: 'Fenni İdiris İhsanoğlu Şensoy', addr: 'Fındıkzade, Eminönü, Istanbul', phone: '+903622324860', email: 'caitlin-schneider68@gmail.com', price: 7.50 },
      { id: 'cc8', bin: '4737034058961682', exp: '11/25', cvv: '462', name: 'Carolyn Cruz', addr: '271 Lakeland Park Dr, Norcross, GA 30071', phone: '+18044922618', email: 'carolyn_cruz@hotmail.com', price: 7.50 },
      { id: 'cc9', bin: '5524331546544375', exp: '02/30', cvv: '880', name: 'Kimberly Ryan', addr: '3681 Briarhill Ln, Youngstown, OH 44502', phone: '+12105168492', email: 'kimberlyryan@gmail.com', price: 7.50 },
      { id: 'cc10', bin: '5414581186914725', exp: '03/30', cvv: '593', name: 'Jasmine Cortez', addr: '316 E Rialto Ave, Rialto, CA 92376', phone: '8579190994', email: '', price: 7.50 },
      { id: 'cc11', bin: '4147400474199385', exp: '07/30', cvv: '296', name: 'Justin Arifaj', addr: '10186 Old Us Hwy 22, Breinigsville, PA 18031', phone: '16105703001', email: 'justin.arifaj@gmail.com', price: 7.50 },
      { id: 'cc12', bin: '4862080020856416', exp: '08/30', cvv: '488', name: 'Jill Skinner', addr: '232 E 26th St, New York, NY 10010', phone: '6303356437', email: 'Jillskinner@hotmail.com', price: 7.50 },
      { id: 'cc13', bin: '5425430187479345', exp: '12/30', cvv: '206', name: 'Kristen Constantine', addr: '12890 Old Meridian St Apt 154, Carmel, IN 46032', phone: '7322786864', email: 'Kris.elizabeth.03@gmail.com', price: 7.50 },
      { id: 'cc14', bin: '4147400230398339', exp: '12/27', cvv: '365', name: 'Shari Abramowitz', addr: '1967 Genova Dr, Oviedo, FL 32765', phone: '7204731118', email: 'akitchenmaven@yahoo.com', price: 7.50 },
      { id: 'cc15', bin: '4447962692476918', exp: '08/27 Cang', cvv: '087', name: 'Leslie Hunt', addr: '150 S 19th Ave 19A, Lemoore, CA 93245', phone: '13174734642', email: 'mlthunt@live.com', price: 7.50 }
    ];

    // RENDER SHOP
    function renderShop() {
      state.cards = realStock;
      const grid = document.getElementById('card-grid'); grid.innerHTML = '';
      const cat = document.querySelector('.cat-tab.active')?.dataset.cat || 'all';
      const search = document.getElementById('search-bar').value.toLowerCase();
      state.cards
        .filter(c => cat === 'all' || c.category === cat)
        .filter(c => !search || c.bin.includes(search) || c.name.toLowerCase().includes(search))
        .forEach(c => {
          const el = document.createElement('div'); el.className = 'card-item';
          el.innerHTML = `<div class="bin">${c.bin}</div><div class="type">${c.exp} | ${c.cvv}</div><div class="price">$7.50</div>`;
          el.onclick = () => { state.selected = c; goTo('detail'); };
          grid.appendChild(el);
        });
    }

    // RENDER DETAIL
    function renderDetail() {
      const c = state.selected;
      const cont = document.getElementById('detail-content');
      cont.innerHTML = `
        <div style="font-size:1.8rem; margin-bottom:12px;">${c.bin}</div>
        <div style="color:#aaa; margin-bottom:18px;">${c.exp} | CVV: ${c.cvv}</div>
        <div style="font-size:1rem; color:#0f0;">${c.name}</div>
        <div style="font-size:0.9rem; color:#aaa;">${c.addr}</div>
        <div style="font-size:0.9rem; color:#aaa;">${c.phone} | ${c.email}</div>
        <div class="price">$7.50</div>
      `;
      document.getElementById('qty-num').textContent = c.qty || 1;
      document.getElementById('max-warning').classList.toggle('show', (c.qty || 1) >= 3);
    }

    // QTY CONTROLS
    document.getElementById('qty-minus').onclick = () => {
      if (state.selected.qty > 1) { state.selected.qty--; renderDetail(); }
    };
    document.getElementById('qty-plus').onclick = () => {
      if (state.selected.qty < 3) { state.selected.qty++; renderDetail(); }
    };

    // ADD TO CART
    document.getElementById('add-to-cart').onclick = () => {
      const existing = state.cart.find(i => i.id === state.selected.id);
      if (existing) {
        if (existing.qty + state.selected.qty <= 3) existing.qty += state.selected.qty;
      } else {
        state.cart.push({...state.selected, qty: state.selected.qty || 1});
      }
      updateCartCount();
      const card = document.querySelector('.card-item:hover') || document.activeElement.closest('.card-item');
      if (card) flyCard(card, document.getElementById('cart-icon'));
      goTo('cart');
    };

    // UPDATE CART COUNT
    function updateCartCount() {
      const total = state.cart.reduce((s, i) => s + i.qty, 0);
      const count = document.getElementById('cart-count');
      count.textContent = total;
      count.style.display = total > 0 ? 'flex' : 'none';
    }

    // RENDER CART
    function renderCart() {
      const items = document.getElementById('cart-items'); items.innerHTML = '';
      let total = 0;
      state.cart.forEach((item, idx) => {
        const price = item.price * item.qty;
        total += price;
        const div = document.createElement('div');
        div.style = 'background:#1a1a1a; padding:16px; border-radius:12px; margin:12px 0;';
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between;">
            <div>${item.bin} ×${item.qty}</div>
            <div>$${price.toFixed(2)}</div>
          </div>
          <button style="background:#333; color:#fff; border:none; padding:6px 12px; border-radius:8px; margin-top:8px; font-size:0.8rem;" onclick="state.cart.splice(${idx},1); renderCart(); updateCartCount();">REMOVE</button>
        `;
        items.appendChild(div);
      });
      document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
    }

    // CHECKOUT
    document.getElementById('checkout-btn').onclick = () => goTo('checkout');
    document.getElementById('clear-cart').onclick = () => { state.cart = []; updateCartCount(); renderCart(); };

    // RENDER CHECKOUT
    function renderCheckout() {
      const total = state.cart.reduce((s, i) => s + i.price * i.qty, 0);
      document.getElementById('checkout-summary').innerHTML = `<p style="text-align:center;">TOTAL: $${total.toFixed(2)}</p>`;
    }

    // PAY — ORDER ID HERE
    document.getElementById('pay-btn').onclick = () => {
      const email = document.getElementById('email').value.trim();
      if (!email || !state.cart.length) return alert('EMAIL + CART REQUIRED');
      state.email = email;
      state.orderId = genId();  // ← FIXED: GENERATED ON PAY
      state.pendingPayment = {
        id: state.orderId,
        amountUsd: state.cart.reduce((s,i)=>s+i.price*i.qty,0),
        amountBtc: 0,
        confirmed: false,
        confs: 0
      };
      goTo('payment');
    };

    // RENDER PAYMENT
    function renderPayment() {
      const totalUsd = state.pendingPayment.amountUsd;
      const totalBtc = (totalUsd / state.btcPrice).toFixed(8);
      state.pendingPayment.amountBtc = totalBtc;

      document.getElementById('payment-summary').innerHTML = `
        <p>ORDER: <strong>${state.orderId}</strong></p>
        <p>AMOUNT: <strong>$${totalUsd.toFixed(2)}</strong> (${totalBtc} BTC)</p>
        <p style="color:#ff0; margin:16px 0;">
          <strong>IMPORTANT:</strong> Send with message: <code style="background:#1a1a1a;padding:4px 8px;border-radius:6px;">${state.orderId}</code>
        </p>
      `;

      const qrData = `bitcoin:${BTC_ADDR}?amount=${totalBtc}&message=${state.orderId}`;
      QRCode.toCanvas(document.getElementById('qr-code'), qrData, { width: 200 });

      if (state.pollInterval) clearInterval(state.pollInterval);
      pollPayment();
      state.pollInterval = setInterval(pollPayment, 20000);
    }

    async function pollPayment() {
      if (!state.pendingPayment || state.pendingPayment.confirmed) return;

      try {
        const res = await fetch(`https://api.blockcypher.com/v1/btc/main/addrs/${BTC_ADDR}/full?token=${BLOCKCYPHER_TOKEN}&limit=50`);
        const data = await res.json();

        const tx = data.txs?.find(t => 
          t.outputs?.some(o => o.message === state.orderId) &&
          t.total >= (state.pendingPayment.amountBtc * 1e8 * 0.99)
        );

        if (tx) {
          const confs = tx.confirmations || 0;
          document.querySelector('.conf-count').textContent = `${confs}/1`;
          
          if (confs >= 1) {
            confirmPayment();
          }
        }
      } catch(e) {}
    }

    function confirmPayment() {
      state.pendingPayment.confirmed = true;
      clearInterval(state.pollInterval);
      document.getElementById('payment-status').className = 'payment-status status-paid';
      document.getElementById('payment-status').innerHTML = 'PAID! Delivery in History.';
      document.getElementById('payment-done').style.display = 'block';

      const order = {
        id: state.orderId,
        email: state.email,
        items: [...state.cart],
        total: state.pendingPayment.amountUsd,
        date: new Date().toLocaleString(),
        paid: true
      };
      state.history.unshift(order);
      localStorage.setItem('rak_history', JSON.stringify(state.history));
      renderHistory();
      goTo('history');
    }

    document.getElementById('payment-done').onclick = () => {
      state.cart = [];
      updateCartCount();
      goTo('order');
    };

    // RENDER ORDER
    function renderOrder() {
      document.getElementById('order-id').textContent = state.orderId;
      const items = document.getElementById('order-items'); items.innerHTML = '';
      state.cart.forEach(i => {
        const div = document.createElement('div');
        div.style = 'background:#1a1a1a; padding:12px; border-radius:8px; margin:8px 0;';
        div.innerHTML = `<p><strong>${i.bin}</strong> ×${i.qty}</p><p>$${ (i.price * i.qty).toFixed(2) }</p>`;
        items.appendChild(div);
      });
    }

    // COPY ALL
    document.getElementById('copy-all').onclick = () => {
      const text = state.cart.map(i => `${i.bin}|${i.exp}|${i.cvv}|${i.name}|${i.addr}|${i.phone}|${i.email}`).join('\n');
      navigator.clipboard.writeText(text);
      const fb = document.getElementById('copy-feedback');
      fb.style.opacity = '1';
      setTimeout(() => fb.style.opacity = '0', 1500);
    };

    // HISTORY — PAID / PENDING
    function renderHistory() {
      const paid = document.getElementById('paid-orders'); paid.innerHTML = '';
      const pending = document.getElementById('pending-orders'); pending.innerHTML = '';
      
      state.history.forEach(h => {
        const div = document.createElement('div');
        div.style = 'background:#1a1a1a; padding:16px; border-radius:12px; margin:12px 0;';
        div.innerHTML = `
          <p><strong>${h.id}</strong> - $${h.total.toFixed(2)}</p>
          <p>${h.date}</p>
          ${h.paid ? '<button style="background:#333; color:#fff; border:none; padding:6px 12px; border-radius:8px; margin-top:8px;" onclick="copyOrderLogs(\'' + h.id + '\')">COPY CC</button>' : '<p style="color:#ff0;">Awaiting 1 conf...</p>'}
        `;
        if (h.paid) paid.appendChild(div);
        else pending.appendChild(div);
      });
    }

    function copyOrderLogs(orderId) {
      const order = state.history.find(o => o.id === orderId);
      if (!order) return;
      const logs = order.items.map(i => `${i.bin}|${i.exp}|${i.cvv}|${i.name}|${i.addr}|${i.phone}|${i.email}`).join('\n');
      navigator.clipboard.writeText(logs);
      const fb = document.getElementById('copy-feedback');
      fb.style.opacity = '1';
      setTimeout(() => fb.style.opacity = '0', 1500);
    }

    // SUPPORT PAGE
    function renderSupport() {
      document.getElementById('support-chat').innerHTML = '<div class="chat-bubble chat-bot">Welcome to RAK Support.<br>Please enter your ORDER ID (RAK-XXXXXX) from History.</div>';
      state.supportStep = '';
    }

    function addChat(sender, msg) {
      const chat = document.getElementById('support-chat');
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${sender === 'You' ? 'chat-you' : 'chat-bot'}`;
      bubble.innerHTML = msg.replace(/\n/g, '<br>');
      chat.appendChild(bubble);
      chat.scrollTop = chat.scrollHeight;
    }

    document.getElementById('send-support').onclick = () => sendSupportMsg();
    document.getElementById('support-input').onkeydown = (e) => { if (e.key === 'Enter') sendSupportMsg(); };

    function sendSupportMsg() {
      const input = document.getElementById('support-input');
      const msg = input.value.trim();
      if (!msg) return;
      addChat('You', msg);
      input.value = '';

      setTimeout(() => {
        if (msg.toUpperCase().includes('RAK-') && state.history.some(h => h.id === msg)) {
          addChat('RAK BOT', `Order ${msg} found.\n\nWhat do you need?\n1. Refund\n2. Replace with new CC (get credit)`);
          state.supportStep = 'order_found';
          state.currentOrder = msg;
        } else if (state.supportStep === 'order_found') {
          if (msg === '1') {
            addChat('RAK BOT', `Refund requested for ${state.currentOrder}.\n\nText @raksupporteam on Telegram with:\n- Order ID: ${state.currentOrder}\n- BTC TXID\n\nRefund in 24h.`);
          } else if (msg === '2') {
            addChat('RAK BOT', `Credit issued for ${state.currentOrder}.\n\nGo to ADD CREDITS → use balance for new CC.\n\nWe restock daily.`);
          } else {
            addChat('RAK BOT', 'Please reply with 1 or 2.');
          }
        } else {
          addChat('RAK BOT', 'Invalid ORDER ID. Check History.');
        }
      }, 800);
    }

    // EVENT DELEGATION
    document.addEventListener('click', e => {
      if (e.target.matches('.cat-tab')) {
        document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        renderShop();
      }
    });
    document.getElementById('search-bar').oninput = () => renderShop();
    document.getElementById('cart-icon').onclick = () => goTo('cart');
    document.getElementById('add-credits-top').onclick = () => goTo('add-credits');
    document.getElementById('history-top').onclick = () => goTo('history');
    document.getElementById('support-btn').onclick = () => goTo('support');

    // LOADER — FIXED TEXT
    setTimeout(() => {
      document.getElementById('loader').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('loader').remove();
        document.getElementById('app').style.display = 'block';
        goTo('login');
      }, 600);
    }, 3000);
  </script>
</body>
</html>
